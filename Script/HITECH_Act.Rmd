---
title: "HITECH_Act_Case"
author: "Karl Grindal"
date: "6/19/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("tidyverse")
library("dplyr")
library("here")
library("tseries")

# Case 1: HITECH Security Law

# Enacted: February 17, 2009
# Enforcement: May 27, 2009

AllStateClean <- read.table(here::here("Data","Other_data","AllStateClean.txt"), sep=";")

AllStateClean$firstdate <- substr(AllStateClean$reported_date, start=1, stop=10) # Use this string for Massachusetts v New Hampshire

HITECH1 <- subset(AllStateClean, AllStateClean$year == 2005)
HITECH2 <- subset(AllStateClean, AllStateClean$year == 2006)
HITECH3 <- subset(AllStateClean, AllStateClean$year == 2007)
HITECH4 <- subset(AllStateClean, AllStateClean$year == 2008)
HITECH5 <- subset(AllStateClean, AllStateClean$year == 2009)
HITECH6 <- subset(AllStateClean, AllStateClean$year == 2010)

HITECH <- rbind(HITECH1, HITECH2, HITECH3, HITECH4, HITECH5, HITECH6)

write.csv(HITECH,here::here("Data","Other_data","HITECH.csv"))

```




```{r}
HITECH <- read.csv(here::here("Data","Other_data","HITECH.csv"))
DUNS <- read.csv(here::here("Data","Other_data","DUNS_HITECH.csv"))

NAICS <- merge(HITECH, DUNS, by="clean_name", all=TRUE)

NAICS$DUNS_2 <- substr(NAICS$Primary.NAICS.Code, start=1, stop=2)
# colSums(!is.na(NAICS)) # 1740 resolved for Duns_2 
# colSums(is.na(NAICS)) # 248 not resolved for Duns_2
NAICS <- NAICS[complete.cases(NAICS$firstdate),] 

248/1740 # = 14.2% are not included
1740/(1740+248) # = 87.5% of incidents are resolved

write.csv(NAICS, here::here("Data","Other_data","NAICS_Clean.csv"))

```

# Specifying Time Variables
```{r}
first_breach_date <- as.Date("2005-12-01") # doesn't change
pop_start <- c(2000,4)
data_start	<- c(2005,12)	# Non Health
# data_start <- c(2006,6) # 
data_range <- c(2005,2011)
exp_start <- c(2008,4)
exp_range <- c(2008,2011)
first_pop_date <- as.Date("2000-04-01")
last_pop_date <- as.Date("2020-12-01")
no_months_out <- 174

months_prior <- 6 # months before treatment start
months_after <- 6 # months after treatment start

# HIGH TECH Act regulations become effective on February 17, 2009
# Enforcement of HIGH TECH Act implement on May 27, 2009

treatment_start <- as.Date("02/17/2009", "%m/%d/%Y")-180 # Legislation H.B. 4144 becomes effective
treatment_end  <- as.Date("05/27/2009", "%m/%d/%Y")+180 # moving avg uses 30 days post treatment

```


# Create Population Time Series for Matching with Incident Frequncy
```{r}
# Population
pop <- read.csv(here::here("Data","Other_data","populations.csv")) # starts at 2000.04.01

datforpop <- data.frame(seq(first_pop_date, last_pop_date,  by="1 month"))
datforpop

datforpop <- datforpop %>%
  set_colnames(c("yearmonth")) %>%
  mutate(yearmonth=format(as.Date(yearmonth), "%Y/%m"))

pop <- pop %>%
  t() %>%
  as.data.frame() %>%
  set_colnames(pop[,1])

pop <- pop[-1,]
pop <- cbind(datforpop,pop)
rownames(pop) <- seq(1:nrow(pop))
pop <- as.data.frame(pop)

pop[2:ncol(pop)] <- sapply(pop[2:ncol(pop)],as.numeric)
pop

# Create a new column for the total population across collecting states
pop$totpop <- rowSums(pop[ ,c('Massachusetts','South Carolina','North Carolina','New Hampshire','Hawaii','Maine')], na.rm=TRUE)

freq_dat <- data.frame(seq(first_breach_date, by="1 month", length.out=(no_months_out)))
freq_dat <- freq_dat %>%
  set_colnames(c("yearmonth")) %>%
  mutate(yearmonth=format(as.Date(yearmonth), "%Y/%m"))
freq_dat
```


# Create Monthly Frequency Accross Full Collected Time
```{r}
# Format control dates into months
NAICS
NAICS$date_formatted <- format(as.Date(NAICS$firstdate, "%Y-%m-%d"), "%Y/%m") # Alternative is "%m/%d/%Y"

NAICS_ts <- NAICS %>% 
  dplyr::group_by(NAICS$date_formatted) %>% 
  dplyr::summarise(frequency = n()) %>% 
  set_colnames(c("yearmonth","frequency"))

# NAICS_ts # Feb 2005 and Dec 2010
NAICS_ts <- merge(NAICS_ts, freq_dat, by="yearmonth", all.y=TRUE)
NAICS_ts$frequency[is.na(NAICS_ts$frequency)]<-0
NAICS

# Look at Raw Frequency Counts
NAICS_ts <- ts(NAICS_ts$frequency, frequency = 12, start = data_start)
ts.plot(NAICS_ts, main = "Breaches over time", xlim=data_range, gpars = list(col = c("black", "red")), xlab = "Years", ylab = "Count per month")

```


# Designate Treatment and Control groups
```{r}
sum(is.na(NAICS$date_formatted)) # no unformated dates
# NAICS <- NAICS[!is.na(NAICS$date_formatted),]

Health <- NAICS[grepl( "62", NAICS$DUNS_2), ]
Finance <- NAICS[grepl( "52", NAICS$DUNS_2), ]
Education <- NAICS[grepl( "61", NAICS$DUNS_2), ]
Information <- NAICS[grepl( "51", NAICS$DUNS_2), ]

Non_Health <- NAICS %>%
                   filter(DUNS_2 != 62)   
#Treat_Name <- 'Massachusetts'
#Ctrl_Name <- 'New Hampshire'

treatment <-  Health # This Must Be Filled in to Work Properly!
control <-  Non_Health  # This Must Be Filled in to Work Properly!

```

# Experiment 1: Create control and treatment populations with Total Incidents
```{r}
treatment_freq <- treatment %>% 
  dplyr::mutate(date_formatted=format(as.Date(reported_date), "%Y/%m")) %>% 
  dplyr::group_by(date_formatted)  %>% 
  dplyr::summarise(frequency = n()) %>% 
  set_colnames(c("yearmonth","frequency")) %>% 
  replace_na(list(frequency=0))

control_freq <- control %>% 
  dplyr::mutate(date_formatted=format(as.Date(reported_date), "%Y/%m")) %>% 
  dplyr::group_by(date_formatted)  %>% 
  dplyr::summarise(frequency = n()) %>% 
  set_colnames(c("yearmonth","frequency")) %>% 
  replace_na(list(frequency=0))

treatment_freq
control_freq

treatment_freq <- merge(treatment_freq,freq_dat, by="yearmonth", all.y=TRUE)
control_freq <- merge(control_freq,freq_dat, by="yearmonth", all.y=TRUE)
treatment_freq$frequency[is.na(treatment_freq$frequency)]<-0
control_freq$frequency[is.na(control_freq$frequency)]<-0

treatment_ts <- ts(treatment_freq$frequency, frequency = 12, start = data_start)
control_ts <- ts(control_freq$frequency, frequency = 12, start = data_start)

plot.ts(treatment_ts, main = "Breaches over time", xlim=data_range, xlab = "Years", ylab = "Count per month")
plot.ts(control_ts, main = "Breaches over time", xlim=data_range, xlab = "Years", ylab = "Count per month")

ts.plot(control_ts, treatment_ts, main = "Breaches over time", xlim=data_range, gpars = list(col = c("black", "red")), xlab = "Years", ylab = "Count per month")

summary(treatment_ts)
summary(control_ts)

```

## Decompose the Control to Find Seasonal Patterns
```{r}

controltimeseriescomponents <- decompose(control_ts)
plot(controltimeseriescomponents, xlim=data_range)
controltimeseriesseasonallyadjusted <- control_ts - controltimeseriescomponents$seasonal
plot(controltimeseriesseasonallyadjusted, xlim=data_range)

```

## Create charts with breaches per million residents
```{r}
# Merge Treatment and Control Together
comb_ts <- merge(treatment_freq, control_freq, by="yearmonth", all=TRUE)

# Merge Combined Treatment and Control Together with Population Statistics
comb_ts <- merge(comb_ts, pop, by='yearmonth', all.x = TRUE)
comb_ts[2:ncol(comb_ts)] <- sapply(comb_ts[2:ncol(comb_ts)],as.numeric)

comb_ts <- comb_ts %>% 
  replace_na(list(frequency.x=0,frequency.y=0)) %>% 
  dplyr::mutate(treatpermil = frequency.x/(totpop/1000000)) %>% 
  dplyr::mutate(controlpermil = frequency.y/(totpop/1000000)) %>% 
  mutate(yearmonth2 = gsub("/","",comb_ts$yearmonth)) %>% 
  dplyr::filter(yearmonth2 > 200511) %>% 
  select(-("yearmonth2"))

treatment_tsM <- ts(comb_ts$treatpermil, frequency = 12, start = data_start)
control_tsM <- ts(comb_ts$controlpermil, frequency = 12, start = data_start)

plot.ts(treatment_tsM, main = "Breaches per Million over time", xlim=data_range, xlab = "Years", ylab = "Breaches per Million Resident During Month")
plot.ts(control_tsM, main = "Breaches per Million over time", xlim=data_range, xlab = "Years", ylab = "Breaches per Million Resident During Month")

ts.plot(control_tsM, treatment_tsM, main = "Breaches over time", xlim=data_range, gpars = list(col = c("black", "red")), xlab = "Years", ylab = "Breaches per Million Resident During Month")


```


## Identifying and subsetting relevant dates
```{r}

treatment_start<- format(as.Date(as.character(treatment_start), origin = "1970-01-01"), "%Y/%m")
treatment_end<- format(as.Date(as.character(treatment_end), origin = "1970-01-01"), "%Y/%m")

pretreat <- comb_ts[(which(comb_ts$yearmonth==treatment_start)-months_prior):which(comb_ts$yearmonth==treatment_start),]
pretreat$type <- "pretest"

posttreat <- comb_ts[which(comb_ts$yearmonth==treatment_end):(which(comb_ts$yearmonth==treatment_end)+months_after),]
posttreat$type <- "posttest"

mean(posttreat$treatpermil) - mean(pretreat$treatpermil)
mean(posttreat$controlpermil) - mean(pretreat$controlpermil)

treatment_range <- comb_ts[(which(comb_ts$yearmonth==treatment_start)+1):(which(comb_ts$yearmonth==treatment_end)-1),]
treatment_range$type <- "test"

experiment <- rbind(pretreat,treatment_range,posttreat)
experiment$treatpermil[is.na(experiment$treatpermil)]<-0
experiment$controlpermil[is.na(experiment$controlpermil)]<-0

ts.plot(experiment$treatpermil, col = "red")
ts.plot(experiment$controlpermil, col = "blue")

# Look at Raw Frequency Counts
treatment_ts <- ts(experiment$frequency.x, frequency = 12, start = exp_start)
control_ts <- ts(experiment$frequency.y, frequency = 12, start = exp_start)
ts.plot(control_ts, treatment_ts, main = "Breaches over time", xlim=exp_range, gpars = list(col = c("black", "red")), xlab = "Years", ylab = "Count per month")

# Look at Treatment and Control per Million
treatment_tsM <- ts(experiment$treatpermil, frequency = 12, start = exp_start)
mean(treatment_tsM)
sd(treatment_tsM)

control_tsM <- ts(experiment$controlpermil, frequency = 12, start = exp_start)
mean(control_tsM)
sd(control_tsM)

ts.plot(control_tsM, treatment_tsM, main = "Breaches over time", xlim=exp_range, 
                    gpars = list(col = c("black", "red")), type = "b", xlab = "Years", ylab = "Count per month")

```



## Run Statistical Tests on Time Series for Stationarity
```{r}
# source of statistical tests http://r-statistics.co/Time-Series-Analysis-With-R.html

acfcontrol <- acf(control_ts) # autocorrelation (i.e. a Time Series with lags of itself)
acftreatment <- acf(treatment_ts)
# shows that the control time series is a "stationary time series"

png(here::here("Output","acfcontrol.png"))
plot(acfcontrol)

png(here::here("Output","acftreatmentNH.png"))
plot(acftreatment)

pacfcontrolNH <- pacf(control_ts)  # partial autocorrelation (i.e. correlation of the time series with a lag of itself, with the linear dependence of all the lags between them removed.)
pacftreatmentMA <- pacf(treatment_ts)  # partial autocorrelation (i.e. correlation of the time series with a lag of itself, with the linear dependence of all the lags between them removed.)

png(here::here("Output","pacfcontrolNH.png"))
plot(pacfcontrolNH)

png(here::here("Output","pacftreatmentMA.png"))
plot(pacftreatmentMA)

ccfRes <- ccf(control_ts, treatment_ts, ylab = "cross-correlation")
ccfRes

# adf test is an Augmented Dickey-Fuller Test
adf.test(control_ts) # p-value < 0.05 indicates the TS is stationary
adf.test(treatment_ts)
kpss.test(control_ts) # Kwiatkowski-Phillips-Schmidt-Shin (KPSS) testz
kpss.test(treatment_ts)

# https://www.sas.com/content/dam/SAS/en_ca/User%20Group%20Presentations/Health-User-Groups/ITS_SAS.pdf

```


## ITS analyses use regression-based techniques
```{r}
quasiexp <- experiment[experiment$type != "test",]

# Added dummy variables for ITS
control <- as.data.frame(t(rbind(quasiexp$yearmonth,quasiexp$controlpermil)))
control$treat <- as.vector(rep(0,nrow(control)))                  # Create example vector
time <- 1:nrow(control)
control$time <- as.vector(time)
control$z <- c(rep(0,6),1:(nrow(control)-6))

treatment <- as.data.frame(t(rbind(quasiexp$yearmonth,quasiexp$treatpermil)))
treatment$treat <- as.vector(rep(1,nrow(control)))                  # Create example vector
time <- 1:nrow(control)
treatment$time <- as.vector(time)
treatment$z <- c(rep(0,6),1:(nrow(control)-6))
treatment

AppendITS <- rbind(treatment,control)
names(AppendITS) <- c("yearmonth","incident_permil","treat","time","z")
AppendITS$incident_permil <- as.numeric(as.character(AppendITS$incident_permil))
AppendITS$time <- as.numeric(as.character(AppendITS$time))
AppendITS$z <- as.numeric(as.character(AppendITS$z))
AppendITS

factor_cols <- c("treat","time","z")

sapply(AppendITS, class)

regTest <- lm(incident_permil ~ time + treat + z, AppendITS) 
summary(regTest)

regTest2 <- lm(incident_permil ~ time * treat * z, AppendITS) 
summary(regTest2)

```




